<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Microsoft 365 Roadmap</title>
  <link rel="stylesheet" href="main.css">
</head>

<body onload="initTheme()">
<header>
  <div style="display:flex;align-items:center;gap:15px;">
    <button onclick="goBack()" class="back-button">‚¨ÖÔ∏è Back</button>
    <div class="logo-title">
      <img src="Pictures/contoso.png" alt="Logo">
      <div class="title-block">
        <div class="env-name">Demo environment</div>
        <div class="page-name">M365 Roadmap</div>
      </div>
    </div>
  </div>
  <div class="icon-bar">
    <span class="theme-toggle" onclick="toggleTheme()">üåì</span>
  </div>
</header>

<div class="page-container">
  <!-- Filters -->
<div class="filter-bar">
  <div class="filter">
    <label for="statusFilter">Filter by status:</label>
    <select id="statusFilter" onchange="applyFilters()">
      <option value="all">All</option>
    </select>
  </div>

  <div class="filter">
    <label for="productFilter">Filter by product:</label>
    <select id="productFilter" onchange="applyFilters()">
      <option value="all">All</option>
    </select>
  </div>
</div>

  <!-- Roadmap cards -->
  <div class="container" id="roadmap-container">
    <!-- Entries injected by JS -->
  </div>
</div>

<!-- Shared helpers -->
<script src="common.js"></script>

<script>
function applyFilters() {
  const status = document.getElementById("statusFilter").value;
  const product = document.getElementById("productFilter").value;
  const entries = document.querySelectorAll(".roadmap-entry");

  entries.forEach(entry => {
    const matchesStatus = entry.dataset.status === status || status === "all";
    const matchesProduct = entry.dataset.product === product || product === "all";
    entry.style.display = matchesStatus && matchesProduct ? "block" : "none";
  });
}

async function loadRoadmapEntries() {
  try {
    const baseUrl = 'https://dscshow.blob.core.windows.net/priv';
    const jsonPath = 'data/Get-MicrosoftRoadmap/Get-MicrosoftRoadmap_latest.json';

    const res = await fetch(`${baseUrl}/${jsonPath}`);
    const data = await res.json();

    const container = document.getElementById("roadmap-container");
    const statusFilter = document.getElementById("statusFilter");
    const productFilter = document.getElementById("productFilter");

    const uniqueStatuses = new Set();
    const uniqueProducts = new Set();
    container.innerHTML = "";

    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "roadmap-entry";
      div.dataset.status = item.Status;
      div.dataset.product = Array.isArray(item.Product) ? item.Product[0] : item.Product;

      uniqueStatuses.add(item.Status);
      uniqueProducts.add(item.Product);

      const productText = Array.isArray(item.Product) ? item.Product.join(", ") : item.Product;

      div.innerHTML = `
        <h3>${item.Title}</h3>
        <p><strong>Status:</strong> ${item.Status}</p>
        <p><strong>Product:</strong> ${productText}</p>
        <p><strong>Release:</strong> ${item.Release}</p>
        <p><strong>Description:</strong> ${item.Description}</p>
        <p><a href="https://www.microsoft.com/microsoft-365/roadmap?featureid=${item.FeatureId}"
              target="_blank" rel="noopener noreferrer">Learn more</a></p>
      `;
      container.appendChild(div);
    });

    // fill dropdowns
    uniqueStatuses.forEach(status => {
      const option = document.createElement("option");
      option.value = status;
      option.textContent = status;
      statusFilter.appendChild(option);
    });

    const flattenedProducts = new Set();
    uniqueProducts.forEach(prod => {
      if (Array.isArray(prod)) prod.forEach(p => flattenedProducts.add(p));
      else flattenedProducts.add(prod);
    });

    flattenedProducts.forEach(p => {
      const option = document.createElement("option");
      option.value = p;
      option.textContent = p;
      productFilter.appendChild(option);
    });

  } catch (err) {
    console.error("Failed to load roadmap entries:", err);
  }
}

window.addEventListener("pageshow", initTheme);
window.addEventListener("load", loadRoadmapEntries);
</script>
<div id="footer-placeholder"></div>
</body>
</html>
