<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Azure Role Assignments</title>
  <!-- keep all styling in main.css -->
  <link rel="stylesheet" href="main.css">
</head>

<body onload="initTheme()">
<header>
  <div style="display:flex;align-items:center">
    <button onclick="goBack()" class="back-button">‚¨ÖÔ∏è Back</button>
    <h1 style="margin:0 auto;font-size:1.2em;font-weight:normal;text-align:center;flex:1">
      <img src="Pictures/logo.jpg" class="resized-img">
      <span style="padding-left:30px">VUSION GROUP</span>
    </h1>
  </div>
  <h2 style="margin:0 auto;font-size:1.2em;text-align:center;flex:1">Azure Role Assignments</h2>
  <div class="icon-bar"><span class="theme-toggle" onclick="toggleTheme()">üåì</span></div>
</header>

<div style="padding:40px">
  <div id="iamCounters" class="indicator-bar"></div>

  <!-- unified selector (management group + subscription) -->
  <select id="filterSelect"
          style="margin-bottom:20px;padding:10px;border-radius:6px;border:1px solid var(--border-color);
                 background:var(--card-bg);color:var(--text-color);">
    <option value="" data-type="">üìÇ Choose a management group or subscription‚Ä¶</option>
  </select>

  <input id="tableSearch" type="text" placeholder="üîç Search..." onkeyup="filterTable()"
         style="margin-left:20px;margin-bottom:20px;padding:10px;width:300px;border-radius:6px;
                border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-color)">

  <table style="width:85%">
    <thead>
      <tr>
        <th style="width:10%" onclick="sortTable(0)">ManagementGroup</th>
        <th style="width:10%" onclick="sortTable(1)">Subscription</th>
        <th style="width:10%" onclick="sortTable(2)">DisplayName</th>
        <th style="width:10%" onclick="sortTable(3)">SignInName</th>
        <th style="width:10%" onclick="sortTable(4)">ObjectType</th>
        <th style="width:15%" onclick="sortTable(5)">RoleDefinitionName</th>
        <th style="width:30%" onclick="sortTable(6)">Scope</th>
      </tr>
    </thead>
    <tbody id="IAMBody"></tbody>
  </table>
</div>

<!-- ------------------------ JavaScript --------------------------- -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<div id="footer-placeholder"></div>
<script>
// Footer loader (unchanged)
(async()=>{try{const resp=await fetch('footer.html');const html=await resp.text();document.getElementById('footer-placeholder').innerHTML=html;}catch(e){console.error('Cannot load footer:',e);}})();

/* ---------------- theme helpers ---------------- */
function initTheme(){ if(localStorage.getItem('theme')==='light') document.body.classList.add('light-mode'); }
function toggleTheme(){ document.body.classList.toggle('light-mode');
                        localStorage.setItem('theme',document.body.classList.contains('light-mode')?'light':'dark'); }
function goBack(){ window.history.length>1 ? window.history.back() : window.location.href='index.html'; }
window.addEventListener('pageshow',initTheme);

/* ---------------- global state ---------------- */
let csvData=[];
const tbody  = document.getElementById('IAMBody');
const select = document.getElementById('filterSelect');

/* ---------------- helper: normalise role ---------------- */
const norm = v=> (v||'').replace(/^"|"$/g,'').trim().toLowerCase();

function showCounters(rows){
  const owners       = rows.filter(r=>norm(r.RoleDefinitionName)==='owner').length;
  const contributors = rows.filter(r=>norm(r.RoleDefinitionName)==='contributor').length;
  const total        = rows.length;
  document.getElementById('iamCounters').textContent=
    `Owners: ${owners} ‚Äì Contributors: ${contributors} ‚Äì Total permissions: ${total}`;
}

/* ---------------- CSV loader ---------------- */
async function loadCsv(){
  const baseUrl="https://supitifrcprdstomonibkp01.blob.core.windows.net/priv";
  const csvPath='data/Get-AZRoleAssignments/Get-AZRoleAssignments_latest.csv';
  const sas='?sv=2025-05-05&se=2025-09-19T06%3A01%3A36Z&sr=c&sp=rl&sig=WP3fzUibO2uzkaFHI%2BgvXyqw8mR6U4ZvqPyL7%2F84OMI%3D'; // replaced by runbook
  const res = await fetch(`${baseUrl}/${csvPath}${sas}`);
  const txt = await res.text();
  const parsed = Papa.parse(txt,{
    header:true,dynamicTyping:true,delimiter:';',skipEmptyLines:true,
    transformHeader:h=>h.trim().replace(/^"|"$/g,'')
  });
  csvData = parsed.data;
}

/* ---------------- build unified list ---------------- */
function buildFilterList(){
  const mgSet  = [...new Set(csvData.map(r=>r.ManagementGroup).filter(Boolean))].sort();
  const subSet = [...new Set(csvData.map(r=>r.Subscription).filter(Boolean))].sort();

  if(mgSet.length){
    const group=document.createElement('optgroup'); group.label='Management Groups';
    mgSet.forEach(name=>{ const o=document.createElement('option'); o.value=name; o.textContent=name; o.dataset.type='mg'; group.appendChild(o);} );
    select.appendChild(group);
  }
  if(subSet.length){
    const group=document.createElement('optgroup'); group.label='Subscriptions';
    subSet.forEach(name=>{ const o=document.createElement('option'); o.value=name; o.textContent=name; o.dataset.type='sub'; group.appendChild(o);} );
    select.appendChild(group);
  }

  select.addEventListener('change',()=>{ renderTable(); filterTable(); });
}

/* ---------------- table render ---------------- */
function renderTable(){
  const chosen = select.value;
  const type   = select.selectedOptions[0]?.dataset.type;
  tbody.innerHTML='';
  if(!chosen){ showCounters([]); return; }

  const rows = csvData.filter(r=> type==='mg' ? r.ManagementGroup===chosen : r.Subscription===chosen );

  rows.forEach(r=>{
    const tr=document.createElement('tr');
    ['ManagementGroup','Subscription','DisplayName','SignInName','ObjectType','RoleDefinitionName','Scope']
      .forEach(k=>{ const td=document.createElement('td'); td.textContent=r[k]??''; tr.appendChild(td);} );
    tbody.appendChild(tr);
  });
  showCounters(rows);
}

/* ---------------- search filter ---------------- */
function filterTable(){
  const q=document.getElementById('tableSearch').value.toLowerCase();
  const rows=[...tbody.rows];
  const visible=[];
  rows.forEach(r=>{
    const hit=r.textContent.toLowerCase().includes(q);
    r.style.display=hit?'':'none';
    if(hit) visible.push(r);
  });
  showCounters(visible.map(r=>({RoleDefinitionName:r.cells[5].textContent})));
}

/* ---------------- sorting ---------------- */
function sortTable(idx){
  const table=tbody.parentElement.parentElement; // <table>
  const rows=[...tbody.rows];
  const asc=table.dataset.sortColumn==idx && table.dataset.sortOrder!=='desc';
  table.dataset.sortColumn=idx; table.dataset.sortOrder=asc?'desc':'asc';
  table.querySelectorAll('th').forEach((th,i)=>{
    const base=th.textContent.replace(/[‚¨ÜÔ∏è‚¨áÔ∏è]/g,'').trim();
    th.textContent=base+(i===idx?(asc?' ‚¨ÜÔ∏è':' ‚¨áÔ∏è'):'');
  });
  rows.sort((a,b)=>{
    const A=a.cells[idx].textContent.toLowerCase(), B=b.cells[idx].textContent.toLowerCase();
    if(!isNaN(A)&&!isNaN(B)) return asc?A-B:B-A;
    return asc?A.localeCompare(B):B.localeCompare(A);
  }).forEach(r=>tbody.appendChild(r));
}

/* ---------------- boot ---------------- */
window.addEventListener('load',async()=>{
  await loadCsv();
  buildFilterList();
  renderTable(); // empty by default
});
</script>
</body>
</html>

