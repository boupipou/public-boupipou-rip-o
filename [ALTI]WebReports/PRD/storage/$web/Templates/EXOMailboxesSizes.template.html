<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mailboxes sizes</title>
  <link rel="stylesheet" href="main.css">
</head>

<body onload="initTheme()">
<header>
  <div style="display: flex; align-items: center; gap: 15px;">
    <button onclick="goBack()" class="back-button">‚¨ÖÔ∏è Back</button>
    <div class="logo-title">
      <img src="Pictures/logo.jpg" alt="Logo">
      <div class="title-block">
        <div class="env-name">ALTISERVICE</div>
        <div class="page-name">Mailboxes Sizes</div>
      </div>
    </div>
  </div>
  <div class="icon-bar">
    <span class="theme-toggle" onclick="toggleTheme()">üåì</span>
  </div>
</header>

<div class="page-container">
  <!-- Counter bar -->
  <div id="mbsizeCounters" class="indicator-bar"></div>

  <!-- Filters -->
  <div class="filters">
    <input id="tableSearch" type="text" placeholder="üîç Search..."
           onkeyup="filterTable()" class="search" />
    <button id="toggleCriticalBtn" onclick="toggleCritical()" class="filter-button">
			  Show Critical Only
		</button>
  </div>

  <!-- Table -->
  <table class="styled-table">
    <thead>
      <tr>
        <th onclick="sortTable(0)">UserPrincipalName</th>
        <th onclick="sortTable(1)">RecipientTypeDetails</th>
				<th onclick="sortTable(2)">MailboxSizePercentFree</th>
				<th onclick="sortTable(3)">MailboxSizeThreshold</th>
				<th onclick="sortTable(4)">RecoverableItemsSizeThreshold</th>
				<th onclick="sortTable(5)">DeletedItemsThreshold</th>
				<th onclick="sortTable(6)">ArchiveSize</th>
				<th onclick="sortTable(7)">AutoExpandingArchiveEnabled</th>
      </tr>
    </thead>
    <tbody id="mbsizeBody"></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="common.js"></script> <!-- ‚úÖ contains theme + footer + helpers -->

<script>
/* ---------------- CSV loader ---------------- */
async function loadCsv() {
  const baseUrl = 'https://altifrcprdwebreportsstg.blob.core.windows.net/priv';
  const csvPath = 'data/Get-MailboxesSizes/Get-MailboxesSizes_latest.csv';
	const sas='<sas>'; // replaced by runbook
  const res = await fetch(`${baseUrl}/${csvPath}${sas}`);
  const txt = await res.text();
  const parsed = Papa.parse(txt,{
    header:true,dynamicTyping:true,delimiter:';',skipEmptyLines:true,
    transformHeader:h=>h.trim().replace(/^"|"$/g,'')
  });
	console.log(parsed.meta.fields); // üëà shows all detected column names
  csvData = parsed.data;
	renderTable(csvData);
	showCounters([...document.querySelectorAll('#mbsizeBody tr')]);
}

/* ---------------- table render ---------------- */
function renderTable(rows) {
  const tbody = document.getElementById('mbsizeBody');
  tbody.innerHTML = '';

  rows.forEach(r => {
    const tr = document.createElement('tr');
    [
      'UserPrincipalName',
      'RecipientTypeDetails',
      'MailboxSizePercentFree',
      'MailboxSizeThreshold',
      'RecoverableItemsSizeThreshold',
      'DeletedItemsThreshold',
      'ArchiveSize',
      'AutoExpandingArchiveEnabled'
    ].forEach(k => {
      const td = document.createElement('td');
      td.textContent = r[k] ?? '';

      // highlight Warning / Critical
      if (['MailboxSizeThreshold','RecoverableItemsSizeThreshold','DeletedItemsThreshold'].includes(k)) {
        if (String(r[k]).toLowerCase() === 'warning') td.classList.add('warning');
        if (String(r[k]).toLowerCase() === 'critical') td.classList.add('critical');
      }

      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // ‚úÖ always recalc from rendered DOM rows
  showCounters([...document.querySelectorAll('#mbsizeBody tr')]);
}

/* ---------------- filters ---------------- */
function filterTable() {
  const q = document.getElementById('tableSearch').value.toLowerCase();
  const rows = [...document.querySelectorAll('#mbsizeBody tr')];
  const visible = rows.filter(r => r.textContent.toLowerCase().includes(q));
  rows.forEach(r => {
    r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
  showCounters(visible);
}

/* ---------------- sorting ---------------- */
function sortTable(idx) {
  const tbody = document.getElementById('mbsizeBody');
  const table = tbody.parentElement.parentElement;
  const rows = [...tbody.rows];
  const asc = table.dataset.sortColumn == idx && table.dataset.sortOrder !== 'desc';
  table.dataset.sortColumn = idx;
  table.dataset.sortOrder = asc ? 'desc' : 'asc';
  table.querySelectorAll('th').forEach((th,i) => {
    const base = th.textContent.replace(/[‚¨ÜÔ∏è‚¨áÔ∏è]/g,'').trim();
    th.textContent = base + (i === idx ? (asc ? ' ‚¨ÜÔ∏è' : ' ‚¨áÔ∏è') : '');
  });
  rows.sort((a,b) => {
    const A = a.cells[idx].textContent.toLowerCase();
    const B = b.cells[idx].textContent.toLowerCase();
    if(!isNaN(A) && !isNaN(B)) return asc ? A-B : B-A;
    return asc ? A.localeCompare(B) : B.localeCompare(A);
  }).forEach(r => tbody.appendChild(r));
}

let criticalMode = false; // state for toggle

function showCounters(rows) {
  const total = rows.length;

  let critical = 0, warning = 0;

  rows.forEach(r => {
    const cells = [...r.querySelectorAll('td')];
    const mailbox = cells[3]?.textContent.toLowerCase();      // MailboxSizeThreshold
    const recov   = cells[4]?.textContent.toLowerCase();      // RecoverableItemsSizeThreshold
    const deleted = cells[5]?.textContent.toLowerCase();      // DeletedItemsThreshold

    if ([mailbox, recov, deleted].includes('critical')) critical++;
    else if ([mailbox, recov, deleted].includes('warning')) warning++;
  });

  document.getElementById('mbsizeCounters').innerHTML = `
    Total: ${total} ‚Äì 
    <span class="critical">Critical: ${critical}</span> ‚Äì 
    <span class="warning">Warning: ${warning}</span>
  `;
}

function toggleCritical() {
  const rows = document.querySelectorAll('#mbsizeBody tr');
  const btn = document.getElementById('toggleCriticalBtn');

  if (!criticalMode) {
    // Enable filter
    let visible = [];
    rows.forEach(r => {
      const cells = [...r.cells];
      const isCritical = 
        (cells[3]?.textContent.toLowerCase() === 'critical') ||
        (cells[4]?.textContent.toLowerCase() === 'critical') ||
        (cells[5]?.textContent.toLowerCase() === 'critical');

      if (isCritical) {
        r.style.display = '';
        visible.push(r);
      } else {
        r.style.display = 'none';
      }
    });
    showCounters(visible);
    btn.textContent = "Show All";
    criticalMode = true;
  } else {
    // Disable filter
    rows.forEach(r => r.style.display = '');
    showCounters([...rows]);
    btn.textContent = "Show Critical Only";
    criticalMode = false;
  }
}

/* ---------------- boot ---------------- */
window.addEventListener('load', loadCsv);
</script>
<div id="footer-placeholder"></div>
</body>
</html>

